<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Panel de Vendedor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  #panel { display: none; }
  table { border-collapse: collapse; width: 100%; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  input[type="number"] { width: 80px; }
  button { padding: 5px 10px; }
</style>
</head>
<body>

<h2>Login de Vendedor</h2>
<div id="login">
  Usuario: <input type="text" id="usuario"><br><br>
  Clave: <input type="password" id="clave"><br><br>
  <button onclick="login()">Ingresar</button>
</div>

<div id="panel">
  <h2>Datos del Vendedor</h2>
  <table id="vendedorTable">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nombre</th>
        <th>Créditos Asignados</th>
        <th>Créditos Usados</th>
        <th>Créditos Disponibles</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h2>Plataformas Asignadas</h2>
  <table id="plataformasTable">
    <thead>
      <tr>
        <th>FechaHora</th>
        <th>Nombre</th>
        <th>Usuario</th>
        <th>Clave</th>
        <th>Créditos</th>
        <th>Agregar Créditos</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
let vendedorLogueado = null;
let plataformasData = [];

const API_URL = "https://script.google.com/macros/s/AKfycbyM6bSk_XEAhKxHIRCrSYOrdYg0lY4yvWC8d4qe_orpA2yCvPD4M4SSD5gu5yafjDio/exec"; // reemplaza con tu URL

function login() {
  const usuario = document.getElementById("usuario").value.trim();
  const clave = document.getElementById("clave").value.trim();

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ usuario, clave }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(data => {
    if(!data.success) { alert(data.message); return; }

    // Encontrar vendedor logueado
    vendedorLogueado = data.vendedores.find(v => v.ID_Vendedor && v.ID_Vendedor === data.vendedores[0].ID_Vendedor);
    
    // Filtrar solo sus plataformas
    plataformasData = data.plataformas.filter(p =>
      String(p.VendedorID).trim() === String(vendedorLogueado.ID_Vendedor).trim()
    );

    document.getElementById("login").style.display = "none";
    document.getElementById("panel").style.display = "block";

    renderVendedor();
    renderPlataformas();
  })
  .catch(err => alert("Error de conexión: " + err));
}

function renderVendedor() {
  const tbody = document.querySelector("#vendedorTable tbody");
  tbody.innerHTML = "";
  if(!vendedorLogueado) return;
  const row = `<tr>
    <td>${vendedorLogueado.ID_Vendedor}</td>
    <td>${vendedorLogueado.Nombre}</td>
    <td>${vendedorLogueado.Creditos_Asignados}</td>
    <td>${vendedorLogueado.Creditos_Usados}</td>
    <td>${vendedorLogueado.Creditos_Disponibles}</td>
  </tr>`;
  tbody.innerHTML = row;
}

function renderPlataformas() {
  const tbody = document.querySelector("#plataformasTable tbody");
  tbody.innerHTML = "";
  plataformasData.forEach((p, i) => {
    tbody.innerHTML += `<tr>
      <td>${p.FechaHora}</td>
      <td>${p.Nombre}</td>
      <td>${p.usuario}</td>
      <td>${p.clave}</td>
      <td>${p.creditos}</td>
      <td><input type="number" id="cred${i}" min="1" value="0"></td>
      <td><button onclick="agregarCreditos(${i})">Agregar</button></td>
    </tr>`;
  });
}

function agregarCreditos(index) {
  const input = document.getElementById(`cred${index}`);
  const creditos = Number(input.value);
  if(creditos <= 0) { alert("Ingrese un número válido"); return; }

  const plataforma = plataformasData[index];

  fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({
      usuario: document.getElementById("usuario").value.trim(),
      clave: document.getElementById("clave").value.trim(),
      creditosAgregar: creditos,
      plataformaURL: plataforma.plataformaURL
    }),
    headers: { "Content-Type": "application/json" }
  })
  .then(res => res.json())
  .then(data => {
    if(!data.success) { alert(data.message); return; }
    alert(data.message);
    input.value = 0;
    login(); // refresca datos del vendedor y plataformas
  })
  .catch(err => alert("Error al agregar créditos: " + err));
}
</script>

</body>
</html>



